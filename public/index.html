<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Zen Verse Flip</title>
    <style>
      body { margin: 0; padding: 0 0 100px; font-family: sans-serif; text-align: center; }
      #banner-ad {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: #eee;
        line-height: 60px;
        border-top: 1px solid #ccc;
        z-index: 100;
      }
    </style>
  </head>
  <body>

    <!-- Pi SDK は残す -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>
      Pi.init({ version: "2.0", sandbox: true });

      // 認証関数（paymentsスコープで決済許可をもらう）
      async function authenticateUser() {
        if (!window.Pi) {
          alert("Pi Browserで開いてください！");
          return false;
        }
        try {
          const scopes = ['payments']; // 決済スコープ必須！
          await Pi.authenticate(scopes, onIncompletePaymentFound);
          console.log("認証成功！決済OK！");
          return true;
        } catch (error) {
          alert("認証エラー: " + error.message);
          console.error(error);
          return false;
        }
      }

      // 未完了決済のコールバック（Pi SDK必須）
      function onIncompletePaymentFound(payment) {
        console.log("未完了決済発見:", payment);
        // テストなので何もしない
      }

      // 仮のバナー広告表示
      window.addEventListener('DOMContentLoaded', () => {
        const banner = document.getElementById('banner-ad');
        if (banner) {
          banner.textContent = 'ここにバナー広告が表示されます';
        }
        // ページロード時に自動認証
        authenticateUser();
      });
    </script>

    <!-- 既存の操作ボタンや日めくりUIはここでレンダリングされる -->
    <div id="root"></div>

    <!-- 下部固定バナー広告枠 -->
    <div id="banner-ad"></div>

    <!-- 手動決済ボタン（一時的・審査用） -->
    <div style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); z-index:999; background:rgba(0,0,0,0.7); padding:10px; border-radius:12px;">
      <button onclick="runTestPayment()" style="padding:12px 24px; background:#5f3dc4; color:white; border:none; border-radius:8px; font-weight:bold; font-size:16px;">
        決済テスト実行（審査用）
      </button>
    </div>

    <script>
    async function runTestPayment() {
      if (!window.Pi) {
        alert("Pi Browserで開いてください！");
        return;
      }
      const authenticated = await authenticateUser();
      if (!authenticated) return;

      try {
        // 決済作成（コールバックは空）
        const payment = await window.Pi.createPayment({
          amount: 0.01,
          memo: "Free app test"
        }, {
          onReadyForServerApproval: () => {},
          onReadyForServerCompletion: () => {},
          onCancel: () => {},
          onError: () => {}
        });

        // 即完了通知（Sandboxハック）
        const paymentId = payment.identifier;
        await window.Pi.completePayment(paymentId, { txid: "sandbox_txid_" + Date.now() });

        alert("決済成功！\nポータルに戻って緑チェックを確認してください！");
        console.log("Piテスト完了", paymentId);
      } catch (e) {
        alert("エラー: " + e.message);
      }
    }
    </script>

  </body>
</html>
